---
const { currentTenant } = Astro.props;

// 1. RECUPERAR LA SESIÓN
const session = Astro.cookies.get('session');
const userId = session?.value;

let userStores = [];
let activeStore = { name: currentTenant, role: 'Visita', logo: '?' };

// 2. CONSULTA A LA BASE DE DATOS REAL (D1)
if (userId && Astro.locals.runtime?.env?.DB) {
  const db = Astro.locals.runtime.env.DB;
  try {
    // NUEVA CONSULTA: Usando memberships
    const result = await db.prepare(`
      SELECT t.name, t.slug, m.role 
      FROM memberships m
      JOIN tenants t ON m.tenant_id = t.id
      WHERE m.user_id = ?
    `).bind(userId).all();

    userStores = result.results.map(store => ({
      ...store,
      logo: store.name.charAt(0).toUpperCase()
    }));

    const found = userStores.find(s => s.slug === currentTenant);
    if (found) activeStore = found;

  } catch (e) {
    console.error(e);
  }
}

// Si no hay base de datos (fallback visual por si acaso)
if (userStores.length === 0) {
   // Esto solo pasará si falla la query o el usuario no tiene tienda
   activeStore = { name: currentTenant, role: 'Invitado', logo: '?' };
}
---

<div class="relative group px-4 py-4 border-b border-gray-200 dark:border-slate-800 cursor-pointer select-none">
  
  {/* CABECERA: TIENDA ACTUAL */}
  <button id="store-trigger" class="w-full flex items-center gap-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg p-2 transition text-left">
    <div class="h-10 w-10 min-w-[2.5rem] rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold shadow-lg text-lg">
      {activeStore.logo}
    </div>
    <div class="flex-1 overflow-hidden">
      <h3 class="font-bold text-gray-900 dark:text-white truncate text-sm leading-tight">
        {activeStore.name}
      </h3>
      <span class="text-[10px] uppercase tracking-wider font-bold text-gray-500 dark:text-gray-400 flex items-center gap-1">
        {activeStore.role}
        <svg class="w-3 h-3 ml-auto opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7 7" /></svg>
      </span>
    </div>
  </button>

  {/* DROPDOWN DESPLEGABLE */}
  <div id="store-dropdown" class="hidden absolute top-full left-4 right-4 mt-2 bg-white dark:bg-[#1f2937] rounded-xl shadow-2xl border border-gray-200 dark:border-slate-700 z-50 overflow-hidden ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 dark:divide-slate-700 transform origin-top transition-all">
    
    <div class="max-h-60 overflow-y-auto py-1">
      <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50 dark:bg-slate-800/50">
        Tus Tiendas
      </div>
      
      {/* AQUI SE PINTAN SOLO LAS TIENDAS DE LA BBDD */}
      {userStores.map((store) => (
        <a 
          href={`https://${store.slug}.tustock.app`} 
          class={`flex items-center gap-3 px-4 py-3 hover:bg-blue-50 dark:hover:bg-slate-700 transition ${store.slug === currentTenant ? 'bg-blue-50/50 dark:bg-slate-800' : ''}`}
        >
          <div class={`h-8 w-8 rounded-md flex items-center justify-center text-white font-bold text-xs ${store.slug === currentTenant ? 'bg-blue-600' : 'bg-gray-400 dark:bg-slate-600'}`}>
            {store.logo}
          </div>
          <div>
             <p class={`text-sm font-medium ${store.slug === currentTenant ? 'text-blue-600 dark:text-blue-400' : 'text-gray-700 dark:text-gray-200'}`}>
               {store.name}
             </p>
             <p class="text-[10px] text-gray-400">{store.role}</p>
          </div>
          {store.slug === currentTenant && (
            <svg class="w-4 h-4 ml-auto text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
          )}
        </a>
      ))}

      {userStores.length === 0 && (
         <div class="px-4 py-3 text-xs text-gray-500 text-center">No se encontraron tiendas.</div>
      )}
    </div>

    {/* Acciones Extra */}
    <div class="bg-gray-50 dark:bg-slate-800/50 py-1">
      <a href={import.meta.env.PROD ? "https://tustock.app/hub" : "/"} class="flex items-center gap-2 px-4 py-2 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        Ir al Hub Central
      </a>
    </div>

  </div>
</div>

<script>
  const trigger = document.getElementById('store-trigger');
  const dropdown = document.getElementById('store-dropdown');
  
  if(trigger && dropdown) {
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
      if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });
  }
</script>