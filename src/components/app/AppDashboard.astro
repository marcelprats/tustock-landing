---
import Layout from '~/layouts/PageLayout.astro';
import StoreSwitcher from './StoreSwitcher.astro';

const { tenant } = Astro.props; // El slug de la tienda (ej: "casamaria")

// 1. OBTENER SESI√ìN
const session = Astro.cookies.get('session');
const userId = session?.value;
const db = Astro.locals.runtime?.env?.DB;

let tenantData = null;
let userRole = null;
let error = null;

if (userId && db && tenant) {
  try {
    // 2. NUEVA CONSULTA DE SEGURIDAD (Usando Memberships)
    // Buscamos si este usuario tiene permiso en esta tienda espec√≠fica
    const membership = await db.prepare(`
      SELECT m.role, t.id, t.name, t.plan_type
      FROM memberships m
      JOIN tenants t ON m.tenant_id = t.id
      WHERE m.user_id = ? AND t.slug = ?
    `).bind(userId, tenant).first();

    if (membership) {
      // ‚úÖ TIENE PERMISO
      tenantData = {
        id: membership.id,
        name: membership.name,
        plan: membership.plan_type,
        slug: tenant
      };
      userRole = membership.role;
    } else {
      // ‚ùå NO TIENE PERMISO (O la tienda no existe)
      error = "No tienes acceso a esta tienda o no existe.";
    }

  } catch (e) {
    console.error("Error Dashboard:", e);
    error = "Error de conexi√≥n con la base de datos.";
  }
}
---

<Layout metadata={{ title: tenantData ? tenantData.name : 'Error' }}>
  
  {/* CASO DE ERROR: Si intenta entrar donde no debe */}
  {error ? (
    <div class="flex flex-col items-center justify-center h-screen bg-gray-50 dark:bg-slate-900">
      <h1 class="text-4xl font-bold text-red-500 mb-4">Acceso Denegado üîí</h1>
      <p class="text-gray-600 dark:text-gray-400 mb-8">{error}</p>
      <a href={import.meta.env.PROD ? "https://tustock.app/hub" : "/"} class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Volver a Mis Tiendas
      </a>
    </div>
  ) : (
  
  /* CASO DE √âXITO: El Dashboard Real */
    <div class="flex h-screen overflow-hidden bg-gray-50 dark:bg-slate-900">
      
      {/* SIDEBAR (Men√∫ Lateral) */}
      <aside class="w-64 flex-shrink-0 border-r border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-950 flex flex-col">
        
        {/* Aqu√≠ usamos el StoreSwitcher actualizado */}
        <StoreSwitcher currentTenant={tenantData.slug} />

        <nav class="flex-1 px-2 py-4 space-y-1">
          {/* TUS ENLACES DEL MEN√ö */}
          <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            Resumen
          </a>
          <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-slate-800 transition">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
            Productos
          </a>
           {/* ... m√°s enlaces ... */}
        </nav>

        {/* PERFIL DE USUARIO (Abajo) */}
        <div class="p-4 border-t border-gray-200 dark:border-slate-800">
          <div class="flex items-center gap-3">
             <div class="h-8 w-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500"></div>
             <div class="text-sm">
               <p class="font-bold text-gray-900 dark:text-white">Mi Usuario</p>
               <p class="text-xs text-gray-500 capitalize">{userRole?.toLowerCase()}</p>
             </div>
          </div>
        </div>
      </aside>

      {/* CONTENIDO PRINCIPAL */}
      <main class="flex-1 overflow-y-auto p-8">
        <header class="flex items-center justify-between mb-8">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
            Panel de Control - {tenantData.name}
          </h1>
          <button class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition">
            + Nueva Venta
          </button>
        </header>

        {/* AQU√ç VA EL RESTO DE TU DASHBOARD (Gr√°ficas, Tablas, etc.) */}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
           <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700">
              <h3 class="text-gray-500 text-sm font-medium">Ventas Hoy</h3>
              <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">0,00 ‚Ç¨</p>
           </div>
           {/* ... */}
        </div>

      </main>

    </div>
  )}
</Layout>