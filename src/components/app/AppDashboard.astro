---
import Layout from '~/layouts/PageLayout.astro';
import StoreSwitcher from './StoreSwitcher.astro';
import ServerStatus from './dashboard/ServerStatus.astro'; 
import { decryptLicense } from '~/utils/crypto'; 

const { tenant } = Astro.props; 

// 1. OBTENER SESI칍N Y ENTORNO
const session = Astro.cookies.get('session');
const userId = session?.value;
const env = Astro.locals.runtime?.env; 
const db = env?.DB;

let tenantData = null;
let userRole = null;
let error = null;

// Variables para el estado visual
let isOnline = false;
let containerClass = "bg-white dark:bg-slate-800";
let statusBadge = "";
let lastUpdateText = "---";

if (userId && db && tenant) {
  try {
    // 2. CONSULTA ACTUALIZADA (A침adimos sales_today y data_updated_at)
    const membership = await db.prepare(`
      SELECT m.role, t.id, t.name, t.plan_type, t.license_encrypted, t.last_heartbeat, 
             t.sales_today, t.data_updated_at
      FROM memberships m
      JOIN tenants t ON m.tenant_id = t.id
      WHERE m.user_id = ? AND t.slug = ?
    `).bind(userId, tenant).first();

    if (membership) {
      
      // --- 游댏 FASE DE DESENCRIPTADO ---
      let realKey = "No disponible";
      try {
        if (membership.license_encrypted && env.MASTER_KEY) {
            realKey = decryptLicense(membership.license_encrypted, env.MASTER_KEY);
        }
      } catch (err) {
        console.error("Error desencriptando:", err);
        realKey = "Error de clave";
      }
      // -------------------------------

      tenantData = {
        id: membership.id,
        name: membership.name,
        plan: membership.plan_type,
        slug: tenant,
        licenseKey: realKey,       
        lastHeartbeat: membership.last_heartbeat,
        salesToday: membership.sales_today || 0,        // <--- NUEVO
        dataUpdatedAt: membership.data_updated_at       // <--- NUEVO
      };
      userRole = membership.role;

      // --- 游놑 L칍GICA DE MODO FANTASMA ---
      const now = Date.now();
      // Consideramos ONLINE si hace menos de 2 minutos (120000 ms)
      isOnline = tenantData.lastHeartbeat && (now - tenantData.lastHeartbeat) < 120000;

      // Clases CSS din치micas (Gris si est치 offline)
      containerClass = isOnline 
        ? "bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700" // VIVO
        : "bg-gray-100 dark:bg-slate-900 border-gray-200 dark:border-slate-800 opacity-60 grayscale"; // FANTASMA

      // Badge de texto
      statusBadge = isOnline
        ? '<span class="text-green-500 bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> LIVE</span>'
        : '<span class="text-gray-500 bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded text-xs font-bold">OFFLINE</span>';

      // Texto de fecha
      lastUpdateText = tenantData.dataUpdatedAt 
        ? new Date(tenantData.dataUpdatedAt).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', day: 'numeric', month: 'numeric'})
        : '---';

    } else {
      error = "No tienes acceso a esta tienda o no existe.";
    }

  } catch (e) {
    console.error("Error Dashboard:", e);
    error = "Error de conexi칩n con la base de datos.";
  }
}
---

<Layout metadata={{ title: tenantData ? tenantData.name : 'Error' }}>
  
  {/* CASO DE ERROR */}
  {error ? (
    <div class="flex flex-col items-center justify-center h-screen bg-gray-50 dark:bg-slate-900">
      <h1 class="text-4xl font-bold text-red-500 mb-4">Acceso Denegado 游</h1>
      <p class="text-gray-600 dark:text-gray-400 mb-8">{error}</p>
      <a href={import.meta.env.PROD ? "https://tustock.app/hub" : "/"} class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Volver a Mis Tiendas
      </a>
    </div>
  ) : (
  
  /* CASO DE 칄XITO */
    <div class="flex h-screen overflow-hidden bg-gray-50 dark:bg-slate-900">
      
      {/* SIDEBAR */}
      <aside class="w-64 flex-shrink-0 border-r border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-950 flex flex-col hidden md:flex">
        
        <StoreSwitcher currentTenant={tenantData.slug} />

        <nav class="flex-1 px-2 py-4 space-y-1">
          <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            Resumen
          </a>
          {/* ... m치s enlaces ... */}
        </nav>

        <div class="p-4 border-t border-gray-200 dark:border-slate-800">
          <div class="flex items-center gap-3">
             <div class="h-8 w-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500"></div>
             <div class="text-sm">
               <p class="font-bold text-gray-900 dark:text-white">Usuario</p>
               <p class="text-xs text-gray-500 capitalize">{userRole?.toLowerCase()}</p>
             </div>
          </div>
        </div>
      </aside>

      {/* CONTENIDO PRINCIPAL */}
      <main class="flex-1 overflow-y-auto p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
              {tenantData.name}
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Visi칩n general de tu negocio</p>
          </div>
        </header>

        {/* 游뚿 AVISO DE TIENDA DESCONECTADA (Solo si !isOnline) */}
        {!isOnline && (
            <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-6 rounded-r shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700 dark:text-red-200">
                            <span class="font-bold">Tienda desconectada.</span> Est치s viendo una copia de seguridad del {lastUpdateText}.
                        </p>
                    </div>
                </div>
            </div>
        )}

        {/* GRID PRINCIPAL */}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
           
           {/* COLUMNA 1: ESTADO DEL SERVIDOR */}
           <div class="lg:col-span-1">
              <ServerStatus 
                licenseKey={tenantData.licenseKey} 
                lastHeartbeat={tenantData.lastHeartbeat} 
              />
           </div>

           {/* COLUMNA 2 y 3: M칄TRICAS (Con efecto Fantasma si offline) */}
           <div class="lg:col-span-2 space-y-6">
              
              {/* Tarjeta de Ventas */}
              <div class={`p-6 rounded-2xl shadow-sm border transition-all duration-500 ${containerClass}`}>
                <div class="flex items-center justify-between mb-4">
                   <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Ventas Hoy</h3>
                   {/* Badge din치mico (LIVE / OFFLINE) */}
                   <div set:html={statusBadge} />
                </div>
                
                {/* DATO REAL DE BBDD */}
                <p class="text-4xl font-bold text-gray-900 dark:text-white">
                    {new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(tenantData.salesToday)}
                </p>
                
                <p class="text-xs text-gray-400 mt-2">
                    {isOnline ? "Sincronizando en tiempo real..." : `Datos guardados: ${lastUpdateText}`}
                </p>
              </div>

              {/* Placeholder para Gr치fica */}
              <div class={`h-64 rounded-2xl shadow-sm border flex items-center justify-center p-6 text-center ${containerClass}`}>
                 <div class="text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-2 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                    <p>Conecta tu tienda para ver las gr치ficas de rendimiento.</p>
                 </div>
              </div>

           </div>
        </div>

      </main>

    </div>
  )}
</Layout>