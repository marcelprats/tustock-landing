---
import Stats from '~/components/widgets/Stats.astro';
import Features2 from '~/components/widgets/Features2.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import { decryptLicense } from '~/utils/crypto'; 

const { tenantId } = Astro.props; 
const session = Astro.cookies.get('session');
const userId = session?.value;
const env = Astro.locals.runtime?.env; 
const db = env?.DB;

let tenantData = { salesToday: 0, licenseKey: '---', lastHeartbeat: 0, dataUpdatedAt: null };
let isOnline = false;
let error = null;

// --- 1. LÓGICA DE DATOS (IGUAL QUE ANTES) ---
if (userId && db && tenantId) {
  try {
    const membership = await db.prepare(`
      SELECT t.id, t.name, t.license_encrypted, t.last_heartbeat, 
             t.sales_today, t.data_updated_at
      FROM memberships m
      JOIN tenants t ON m.tenant_id = t.id
      WHERE m.user_id = ? AND t.slug = ?
    `).bind(userId, tenantId).first();

    if (membership) {
      let realKey = "Error";
      try {
        if (membership.license_encrypted && env.MASTER_KEY) {
            realKey = decryptLicense(membership.license_encrypted, env.MASTER_KEY);
        }
      } catch (err) { console.error(err); }

      tenantData = {
        salesToday: membership.sales_today || 0,
        licenseKey: realKey,
        lastHeartbeat: membership.last_heartbeat,
        dataUpdatedAt: membership.data_updated_at
      };

      isOnline = tenantData.lastHeartbeat && (Date.now() - tenantData.lastHeartbeat) < 120000;
    }
  } catch (e) {
    error = "Error de conexión";
  }
}

// --- 2. PREPARACIÓN DE DATOS PARA WIDGETS ---

const salesFormatted = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(tenantData.salesToday);
const lastUpdate = tenantData.dataUpdatedAt 
    ? new Date(tenantData.dataUpdatedAt).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}) 
    : '---';

const statsData = [
    { title: 'Ventas Hoy', amount: salesFormatted, icon: 'tabler:currency-euro' },
    { title: 'Estado', amount: isOnline ? 'Online' : 'Offline', icon: isOnline ? 'tabler:wifi' : 'tabler:wifi-off' },
    { title: 'Última sincro', amount: lastUpdate, icon: 'tabler:clock' },
    { title: 'Licencia', amount: 'Activa', icon: 'tabler:license' },
];

const menuItems = [
    {
        title: 'Inventario',
        description: 'Gestiona productos y stock.',
        icon: 'tabler:package',
    },
    {
        title: 'Pedidos',
        description: 'Revisa el historial de ventas.',
        icon: 'tabler:list',
    },
    {
        title: 'Configuración',
        description: 'Ajustes de la tienda.',
        icon: 'tabler:settings',
    },
];
---

{error ? (
  <div class="max-w-4xl mx-auto p-4 bg-red-50 text-red-600 rounded-lg text-center font-bold">
    {error}
  </div>
) : (
  <div class="space-y-8 pb-12">
      
      {/* 1. WIDGET DE ESTADÍSTICAS (KPIs) */}
      <Stats
        title="Rendimiento Diario"
        subtitle="Métricas clave actualizadas en tiempo real."
        stats={statsData}
      />

      {/* 2. ALERTA OFFLINE (Usando CallToAction estilizado) */}
      {!isOnline && (
          <div class="max-w-6xl mx-auto px-4 sm:px-6">
            <div class="bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-yellow-100 dark:bg-yellow-800 rounded-full text-yellow-700 dark:text-yellow-100">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-yellow-800 dark:text-yellow-100">Modo Desconectado</h3>
                        <p class="text-yellow-700 dark:text-yellow-200 text-sm">Mostrando datos cacheados ({lastUpdate}). Revisa tu conexión.</p>
                    </div>
                </div>
                <button class="px-4 py-2 bg-yellow-600 text-white rounded font-bold hover:bg-yellow-700 transition">
                    Reconectar
                </button>
            </div>
          </div>
      )}

      {/* 3. MENÚ DE GESTIÓN (Usando Features2 para el grid bonito) */}
      <Features2
        title="Gestión Rápida"
        subtitle="Accede a las herramientas principales."
        items={menuItems}
        columns={3}
      >
        <fragment slot="bg">
            <div class="absolute inset-0 bg-blue-50 dark:bg-slate-900 pointer-events-none" aria-hidden="true"></div>
        </fragment>
      </Features2>

      {/* 4. SERVER KEY (Call to action simple) */}
      <CallToAction
        title="Vinculación de Servidor"
        subtitle={`Tu clave de licencia segura es: ${tenantData.licenseKey.substring(0,8)}...`}
        actions={[
          {
            variant: 'secondary',
            text: 'Copiar Clave Completa',
            href: '#',
            icon: 'tabler:copy',
          },
        ]}
      />

  </div>
)}