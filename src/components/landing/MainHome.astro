---
import Hero from '~/components/widgets/Hero.astro';
import Features3 from '~/components/widgets/Features3.astro';
import Steps from '~/components/widgets/Steps.astro';
import Content from '~/components/widgets/Content.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import PricingSection from '~/components/widgets/PricingSection.astro';
import Stats from '~/components/widgets/Stats.astro';
import Brands from '~/components/widgets/Brands.astro';

const { shopCount, userCount } = Astro.props;

const navItems = [
  { text: 'Inicio', target: 'hero' },
  { text: 'Tecnología', target: 'features' },
  { text: 'IA Local', target: 'ai-core' },
  { text: 'Fiscalidad', target: 'fiscalidad' },
  { text: 'Migración', target: 'steps' },
  { text: 'Precios', target: 'pricing' },
  { text: 'FAQ', target: 'faq' },
];
---

<div class="relative w-full">
  
  <aside class="hidden xl:flex fixed left-6 top-1/2 -translate-y-1/2 z-50 flex-col gap-6 pointer-events-none">
    <nav class="pointer-events-auto flex flex-col gap-5 p-4 bg-white/10 dark:bg-slate-900/40 backdrop-blur-md rounded-full border border-white/20 dark:border-white/5 shadow-2xl transition-all duration-300">
      
      {navItems.map(({ text, target }) => (
        <a 
          href={`#${target}`} 
          class="nav-link group relative flex items-center justify-center w-4 h-full"
          data-target={target}
        >
          <span class="absolute left-12 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 bg-slate-900 text-white text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 rounded-md shadow-xl pointer-events-none whitespace-nowrap z-50">
            {text}
          </span>
          
          <div class="indicator w-1.5 h-1.5 rounded-full bg-slate-400/40 dark:bg-slate-500/40 transition-all duration-300 ease-out group-hover:bg-blue-400"></div>
        </a>
      ))}
    </nav>
  </aside>

  <div class="flex-1 w-full">
    
    <div id="hero" class="scroll-target min-h-screen">
      <Hero
        actions={[
          { variant: 'primary', text: 'Descargar App Escritorio', href: '/download', icon: 'tabler:download' },
          { text: 'Usar versión Web', href: '/register' },
        ]}
        image={{ src: '~/assets/images/hero-image.png', alt: 'TuStock' }}
      >
        <fragment slot="title">
          <span class="block animate-none">ERP Híbrido: Potencia Local</span>
          <span class="text-accent dark:text-white highlight animate-none">Libertad en la Nube</span>
        </fragment>
        <fragment slot="subtitle">
            Gestión de stock con <b>App de Escritorio</b> y sincronización Cloud. IA local para máxima privacidad.
        </fragment>
      </Hero>
    </div>

    <div class="border-y border-gray-100 dark:border-slate-800 bg-blue-50/30 dark:bg-slate-900/30 backdrop-blur-sm">
      <Stats stats={[
        { title: 'Tiendas', amount: shopCount },
        { title: 'Usuarios', amount: userCount },
        { title: 'IA Local', amount: 'Sí' },
        { title: 'Fiscalidad', amount: '2026' }
      ]} />
    </div>

    <div id="features" class="scroll-target"><Features3 title="Retail OS" subtitle="Offline & Online sync." tagline="Híbrido" columns={3} items={[{ title: 'Base Local', description: '0 latencia.', icon: 'tabler:database' }, { title: 'Sync Cloud', description: 'Respaldo total.', icon: 'tabler:cloud-upload' }, { title: 'IA', description: 'Habla con tus datos.', icon: 'tabler:message-chatbot' }, { title: 'TPV', description: 'Rápido.', icon: 'tabler:device-desktop-analytics' }, { title: 'Factura E', description: 'Legal 2026.', icon: 'tabler:certificate' }, { title: 'Privacidad', description: 'Cifrado On-Device.', icon: 'tabler:shield-lock' }]} /></div>

    <div id="ai-core" class="py-10 bg-slate-50 dark:bg-slate-800/20 scroll-target"><Content isReversed tagline="Edge AI" title="Potencia Real" items={[{ title: 'Local', description: 'Sin coste por token.' }, { title: 'Mapeo', description: 'Importa cualquier Excel.' }, { title: 'Stock', description: 'Predicciones reales.' }]} image={{ src: 'https://images.unsplash.com/photo-1620712943543-bcc4688e7485?auto=format&fit=crop&w=800&q=80', alt: 'AI' }} /></div>

    <div id="fiscalidad" class="scroll-target"><Content tagline="Legal" title="Ley 2026" items={[{ title: 'VeriFactu', description: 'Envío AEAT.' }, { title: 'B2B', description: 'Facturae obligatoria.' }]} image={{ src: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?auto=format&fit=crop&w=800&q=80', alt: 'Fiscal' }} /></div>

    <div id="steps" class="scroll-target"><Steps title="Migración" items={[{ title: 'Excel', description: 'Sube tu archivo.', icon: 'tabler:file-upload' }, { title: 'Mapeo', description: 'IA lo ordena.', icon: 'tabler:wand' }, { title: 'Vende', description: 'Listo.', icon: 'tabler:refresh' }]} /></div>

    <div id="pricing" class="bg-blue-50 dark:bg-slate-900/40 scroll-target"><PricingSection title="Precios" prices={[{ title: 'Community', price: '0' }, { title: 'Pro', price: 29, hasRibbon: true }, { title: 'Enterprise', price: '99' }]} /></div>

    <div id="faq" class="scroll-target"><FAQs title="FAQ" items={[{ title: '¿Mac?', description: 'Sí.' }]} /></div>

    <CallToAction actions={[{ variant: 'primary', text: 'Empezar Gratis', href: '/register' }]}><fragment slot="title">Toma el control</fragment></CallToAction>

  </div>
</div>

<script is:inline>
  function updateScrollSpy() {
    const sections = document.querySelectorAll('.scroll-target');
    const navLinks = document.querySelectorAll('.nav-link');
    
    // El centro de la pantalla del usuario
    const viewportCenter = window.innerHeight / 2;
    
    let closestSectionId = "";
    let minDistance = Infinity;

    sections.forEach(section => {
      // Obtenemos la caja de la sección
      const rect = section.getBoundingClientRect();
      // Calculamos el centro de la sección relativo a la pantalla
      const sectionCenter = rect.top + (rect.height / 2);
      // Distancia entre el centro de la sección y el centro de la pantalla
      const distance = Math.abs(viewportCenter - sectionCenter);

      if (distance < minDistance) {
        minDistance = distance;
        closestSectionId = section.getAttribute('id');
      }
    });

    // Pintar el menú
    navLinks.forEach(link => {
      const indicator = link.querySelector('.indicator');
      const target = link.getAttribute('data-target');

      if (target === closestSectionId) {
        // ACTIVADO: Barra Vertical
        indicator.className = "indicator w-2 h-8 rounded-full bg-blue-600 shadow-[0_0_15px_rgba(37,99,235,0.8)] transition-all duration-300";
      } else {
        // DESACTIVADO: Punto Gris
        indicator.className = "indicator w-1.5 h-1.5 rounded-full bg-slate-400/40 dark:bg-slate-500/40 transition-all duration-300";
      }
    });
  }

  // Escuchar scroll y resize (el resize es importante por si giran el movil)
  window.addEventListener('scroll', updateScrollSpy, { passive: true });
  window.addEventListener('resize', updateScrollSpy);
  
  // Ejecutar al cargar
  document.addEventListener('DOMContentLoaded', updateScrollSpy);
  // Por si Astro hace cosas raras con el DOM, ejecutamos también a los 200ms
  setTimeout(updateScrollSpy, 200);
</script>