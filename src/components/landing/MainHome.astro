---
import Hero from '~/components/widgets/Hero.astro';
import Features3 from '~/components/widgets/Features3.astro';
import Steps from '~/components/widgets/Steps.astro';
import Content from '~/components/widgets/Content.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import PricingSection from '~/components/widgets/PricingSection.astro';
import Stats from '~/components/widgets/Stats.astro';
import Brands from '~/components/widgets/Brands.astro';

const { shopCount, userCount } = Astro.props;

const navItems = [
  { text: 'Inicio', target: 'hero' },
  { text: 'Tecnología', target: 'features' },
  { text: 'IA Local', target: 'ai-core' },
  { text: 'Fiscalidad', target: 'fiscalidad' },
  { text: 'Migración', target: 'steps' },
  { text: 'Precios', target: 'pricing' },
  { text: 'FAQ', target: 'faq' },
];
---

<div class="relative w-full overflow-x-hidden">
  
  <aside class="hidden xl:flex fixed left-6 top-1/2 -translate-y-1/2 z-50 flex-col gap-6 pointer-events-none">
    <nav class="pointer-events-auto flex flex-col gap-5 p-4 bg-white/10 dark:bg-slate-900/40 backdrop-blur-md rounded-full border border-white/20 dark:border-white/5 shadow-2xl transition-all duration-500 hover:bg-white/20 dark:hover:bg-slate-900/60">
      
      {navItems.map(({ text, target }) => (
        <a 
          href={`#${target}`} 
          class="nav-link group relative flex items-center justify-center w-4 h-full transition-all duration-300"
          data-target={target}
          aria-label={text}
        >
          <span class="absolute left-12 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 bg-slate-900 text-white text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 rounded-md shadow-xl pointer-events-none whitespace-nowrap z-50">
            {text}
          </span>
          
          <div class="indicator w-1.5 h-1.5 rounded-full bg-slate-400/40 dark:bg-slate-500/40 transition-all duration-500 ease-out group-hover:bg-blue-400 group-hover:scale-110"></div>
        </a>
      ))}

    </nav>
  </aside>

  <div class="flex-1 w-full">
    
    <div id="hero" class="scroll-section">
      <Hero
        actions={[
          { variant: 'primary', text: 'Descargar App Escritorio', href: '/download', icon: 'tabler:download' },
          { text: 'Usar versión Web', href: '/register' },
        ]}
        image={{ src: '~/assets/images/hero-image.png', alt: 'TuStock Interface' }}
      >
        <fragment slot="title">
          ERP Híbrido: Potencia Local, <br class="hidden md:inline" />
          <span class="text-accent dark:text-white highlight">Libertad en la Nube</span>
        </fragment>
        <fragment slot="subtitle">
          Gestión de stock con <b>App de Escritorio</b> y sincronización Cloud.
          <br/> Ejecuta la <b>IA en tu PC</b> para máxima privacidad.
        </fragment>
      </Hero>
    </div>

    <div class="border-y border-gray-100 dark:border-slate-800 bg-blue-50/30 dark:bg-slate-900/30 backdrop-blur-sm">
      <Stats
        stats={[
          { title: 'Tiendas', amount: shopCount },
          { title: 'Usuarios', amount: userCount },
          { title: 'IA Local', amount: 'Sí' },
          { title: 'Fiscalidad', amount: '2026' },
        ]}
      />
    </div>

    <div id="features" class="scroll-section">
      <Features3
        title="Sistema Operativo Retail"
        subtitle="Trabaja offline. Sincroniza online."
        tagline="Híbrido"
        columns={3}
        isBeforeContent={true}
        items={[
          { title: 'Base de Datos Local', description: '0 latencia. Funciona sin internet.', icon: 'tabler:database' },
          { title: 'Sync Cloud', description: 'Respaldo automático en la nube.', icon: 'tabler:cloud-upload' },
          { title: 'Consultas IA', description: 'Habla con tu inventario.', icon: 'tabler:message-chatbot' },
          { title: 'TPV Rápido', description: 'Optimizado para velocidad.', icon: 'tabler:device-desktop-analytics' },
          { title: 'Factura Electrónica', description: 'XML legal y firma digital.', icon: 'tabler:certificate' },
          { title: 'Cifrado Local', description: 'Tus datos son tuyos.', icon: 'tabler:shield-lock' },
        ]}
      />
    </div>

    <div id="ai-core" class="py-10 bg-slate-50 dark:bg-slate-800/20 scroll-section">
      <Content
        isReversed
        tagline="Edge AI"
        title="Potencia en tu Hardware"
        items={[
          { title: 'Procesamiento Local', description: 'Usa tu GPU/CPU para correr la IA sin coste por token.' },
          { title: 'Importación Inteligente', description: 'Mapeo automático de Excel y CSV.' },
          { title: 'Predicción', description: 'Cálculo de roturas de stock.' },
        ]}
        image={{ src: 'https://images.unsplash.com/photo-1620712943543-bcc4688e7485?ixlib=rb-4.0.3&auto=format&fit=crop&w=1965&q=80', alt: 'AI' }}
      />
    </div>

    <div id="fiscalidad" class="scroll-section">
      <Content
        tagline="Legal 2026"
        title="Hacienda Ready"
        items={[
          { title: 'VeriFactu', description: 'Envío inmediato a la AEAT.' },
          { title: 'Facturae B2B', description: 'Formatos estructurados obligatorios.' },
          { title: 'Validación', description: 'Detección de errores fiscales.' },
        ]}
        image={{ src: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80', alt: 'Legal' }}
      />
    </div>

    <div id="steps" class="scroll-section">
      <Steps
        title="Migración en minutos"
        items={[
          { title: '1. Arrastra Excel', description: 'Cualquier formato.', icon: 'tabler:file-upload' },
          { title: '2. IA Mapea', description: 'Entendemos tus columnas.', icon: 'tabler:wand' },
          { title: '3. Vende', description: 'Stock listo al instante.', icon: 'tabler:refresh' },
        ]}
        image={{ src: 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80', alt: 'Import' }}
      />
    </div>

    <div id="pricing" class="bg-blue-50 dark:bg-slate-900/40 scroll-section">
      <PricingSection
        title="Precios"
        prices={[
          {
            title: 'Community', price: '0', period: '/mes',
            items: [{ description: 'Hasta 100 productos' }, { description: 'TPV Básico' }],
            callToAction: { target: '_self', text: 'Gratis', href: '/register' },
          },
          {
            title: 'Pro', price: 29, period: '/mes', hasRibbon: true, ribbonTitle: 'Recomendado',
            items: [{ description: 'Ilimitado' }, { description: 'IA Fiscal' }, { description: 'Soporte' }],
            callToAction: { target: '_self', text: 'Prueba 14 días', href: '/register?plan=pro' },
          },
          {
            title: 'Enterprise', price: '99', period: '/mes',
            items: [{ description: 'Servidor Dedicado' }, { description: 'API' }],
            callToAction: { target: '_self', text: 'Contactar', href: '/contact' },
          },
        ]}
      />
    </div>

    <div id="faq" class="scroll-section">
      <FAQs
        title="Dudas Comunes"
        items={[
          { title: '¿Requisitos?', description: 'PC moderno para IA local, o usa la nube.' },
          { title: '¿Mac/Windows?', description: 'Sí, compatible con ambos.' },
          { title: '¿Ley Crea y Crece?', description: 'Sí, 100% adaptado.' },
        ]}
      />
    </div>

    <Brands
      title="Tech Stack"
      icons={[]}
      images={[
        { src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Postgresql_elephant.svg/1200px-Postgresql_elephant.svg.png', alt: 'PostgreSQL' },
        { src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Stripe_Logo%2C_revised_2016.svg/2560px-Stripe_Logo%2C_revised_2016.svg.png', alt: 'Stripe' },
        { src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/React-icon.svg/1200px-React-icon.svg.png', alt: 'React Native' },
      ]}
    />

    <CallToAction
      actions={[{ variant: 'primary', text: 'Empezar Gratis', href: '/register', icon: 'tabler:download' }]}
    >
      <fragment slot="title">Toma el control hoy</fragment>
    </CallToAction>

  </div>
</div>

<style is:global>
  html {
    scroll-behavior: smooth;
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    
    // 1. Configuramos el observador
    // rootMargin: '-50% 0px -50% 0px' -> Esto crea una línea horizontal invisible en el CENTRO de la pantalla.
    // Solo se activa cuando un elemento cruza esa línea exacta.
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          activateMenuLink(id);
        }
      });
    }, { rootMargin: '-50% 0px -50% 0px' });

    // 2. Función para pintar el menú
    function activateMenuLink(id) {
      document.querySelectorAll('.nav-link').forEach(link => {
        const indicator = link.querySelector('.indicator');
        const target = link.getAttribute('data-target');

        if (target === id) {
          // ACTIVO: Barra Vertical Azul Brillante
          link.classList.add('active');
          if (indicator) {
            indicator.className = "indicator w-2 h-8 rounded-full bg-blue-600 shadow-[0_0_15px_rgba(37,99,235,0.8)] transition-all duration-300";
          }
        } else {
          // INACTIVO: Punto Gris Pequeño
          link.classList.remove('active');
          if (indicator) {
            indicator.className = "indicator w-1.5 h-1.5 rounded-full bg-slate-400/40 dark:bg-slate-500/40 transition-all duration-300 group-hover:bg-blue-400 group-hover:scale-110";
          }
        }
      });
    }

    

    // 3. Empezar a observar
    document.querySelectorAll('.scroll-section').forEach(section => {
      observer.observe(section);
    });

  });
</script>