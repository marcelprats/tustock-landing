---
import CustomStyles from "~/components/CustomStyles.astro";
import Favicons from "~/components/Favicons.astro";
import Metadata from "~/components/common/Metadata.astro";
import ApplyColorMode from "~/components/common/ApplyColorMode.astro";
import BasicScripts from "~/components/common/BasicScripts.astro";
import { decryptLicense } from '~/utils/crypto';

// Recibimos parámetros
const { tenant, metadata = {} } = Astro.props;

// 1. OBTENER DATOS MÍNIMOS
const session = Astro.cookies.get('session');
const userId = session?.value;
const env = Astro.locals.runtime?.env;
const db = env?.DB;

let tenantName = "Cargando...";
let isOnline = false;
let error = null;

if (userId && db && tenant) {
  try {
    const data = await db.prepare(`
      SELECT t.name, t.last_heartbeat FROM tenants t
      JOIN memberships m ON t.id = m.tenant_id
      WHERE m.user_id = ? AND t.slug = ?
    `).bind(userId, tenant).first();

    if (data) {
      tenantName = data.name;
      // Online si heartbeat < 2 min
      isOnline = data.last_heartbeat && (Date.now() - data.last_heartbeat) < 120000;
    } else {
      error = "No tienes acceso.";
    }
  } catch (e) {
    error = "Error DB";
  }
}
---

<!doctype html>
<html lang="es" class="motion-safe:scroll-smooth" dir="ltr">
  <head>
    <Metadata {...metadata} />
    <CustomStyles />
    <Favicons />
    <ApplyColorMode />
  </head>

  <body class="antialiased text-default bg-gray-50 dark:bg-slate-900 tracking-tight h-screen overflow-hidden">
    
    {error ? (
        <div class="flex flex-col items-center justify-center h-full">
            <h1 class="text-2xl font-bold text-red-500 mb-2">Acceso Restringido</h1>
            <p class="text-gray-500 mb-6">{error}</p>
            <a href="/" class="btn-primary px-4 py-2 rounded">Salir</a>
        </div>
    ) : (
        <div class="flex h-full w-full">
            
            {/* --- SIDEBAR LIMPIO (Sin Powered By) --- */}
            <aside class="w-64 flex-shrink-0 bg-white dark:bg-slate-950 border-r border-gray-200 dark:border-slate-800 flex flex-col hidden md:flex">
                
                {/* 1. CABECERA SIDEBAR: Nombre de la Tienda */}
                <div class="h-16 flex items-center px-6 border-b border-gray-100 dark:border-slate-900">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold text-lg">
                            {tenantName.charAt(0)}
                        </div>
                        <div class="leading-tight">
                            <h2 class="font-bold text-gray-900 dark:text-white truncate w-32" title={tenantName}>
                                {tenantName}
                            </h2>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Admin Panel</p>
                        </div>
                    </div>
                </div>

                {/* 2. MENÚ DE NAVEGACIÓN */}
                <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                    
                    <a href="#" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400">
                        {/* Icono Home */}
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        Dashboard
                    </a>
                    
                    <a href="#" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-900 transition">
                         {/* Icono Caja */}
                         <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                         Productos
                    </a>

                </nav>

                {/* 3. FOOTER SIDEBAR (Usuario) */}
                <div class="p-4 border-t border-gray-100 dark:border-slate-900">
                     <div class="flex items-center justify-between">
                         <div class="flex items-center gap-2">
                             <div class="w-2 h-2 rounded-full bg-green-500"></div>
                             <span class="text-xs text-gray-500">Usuario Activo</span>
                         </div>
                         <a href="/api/logout" class="text-xs font-bold text-red-500 hover:underline">Salir</a>
                     </div>
                </div>
            </aside>

            {/* --- ZONA PRINCIPAL --- */}
            <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 dark:bg-slate-900">
                
                {/* Header Móvil */}
                <header class="h-16 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 flex md:hidden items-center justify-between px-4">
                    <span class="font-bold">{tenantName}</span>
                    <a href="/api/logout" class="text-sm text-red-500">Salir</a>
                </header>

                {/* SLOT DEL CONTENIDO */}
                <div class="flex-1 overflow-y-auto p-6 md:p-8">
                    <slot />
                </div>

            </main>
        </div>
    )}

    <BasicScripts />
  </body>
</html>