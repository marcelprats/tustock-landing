---
import MainHome from '../components/landing/MainHome.astro';
import AppDashboard from '../components/app/AppDashboard.astro';
import HubSelector from '../components/app/HubSelector.astro';

// 1. DETECCIÓN DE SUBDOMINIO (TENANT)
const url = new URL(Astro.request.url);
const hostname = url.hostname;
let isSubdomain = false;
let tenantSlug = '';

// En Producción (tustock.app)
if (import.meta.env.PROD) {
  if (hostname.endsWith('.tustock.app') && hostname !== 'tustock.app' && hostname !== 'www.tustock.app') {
    isSubdomain = true;
    tenantSlug = hostname.split('.')[0];
  }
} 
// En Local (localhost) - Usamos ?tenant=nombre para simular
else {
  if (url.searchParams.has('tenant')) {
    isSubdomain = true;
    tenantSlug = url.searchParams.get('tenant');
  }
}

// 2. DETECCIÓN DE SESIÓN (Cookie Global)
const session = Astro.cookies.get('session');
const isLoggedIn = session && session.value;

// 3. LÓGICA DE SEGURIDAD PARA SUBDOMINIOS
if (isSubdomain) {
  // Si intentas entrar a una tienda sin estar logueado...
  if (!isLoggedIn) {
    // Te mandamos al login, pero recordamos dónde querías ir (?return_to=...)
    // IMPORTANTE: Redirigimos al dominio principal para que pueda loguearse
    const loginUrl = import.meta.env.PROD 
      ? `https://tustock.app/login?return_to=${tenantSlug}` 
      : `/login?return_to=${tenantSlug}`;
      
    return Astro.redirect(loginUrl);
  }
  
  // (Opcional) Aquí verificarías en BBDD si el usuario tiene permiso en 'tenantSlug'
}
---

{
  isSubdomain
    ? <AppDashboard tenant={tenantSlug} />  // CASO A: App Privada (Tienda)
    : isLoggedIn 
      ? <HubSelector />                     // CASO B: Usuario Logueado (Selector)
      : <MainHome />                        // CASO C: Usuario Anónimo (Landing)
}