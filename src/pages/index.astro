---
import Layout from '~/layouts/PageLayout.astro';
import MainHome from '~/components/landing/MainHome.astro';
import StoreFront from '~/components/storefront/StoreFront.astro'; // Componente nuevo (Punto 5)

const url = new URL(Astro.request.url);
const hostname = url.hostname;
let isSubdomain = false;
let tenantSlug = '';

// 1. DETECTAR SUBDOMINIO
if (import.meta.env.PROD) {
  // En producción, cualquier cosa que NO sea tustock.app es una tienda
  if (hostname !== 'tustock.app' && hostname !== 'www.tustock.app') {
    isSubdomain = true;
    tenantSlug = hostname.split('.')[0];
  }
} else {
  // En local simulamos con ?tenant=fruteria
  if (url.searchParams.has('tenant')) {
    isSubdomain = true;
    tenantSlug = url.searchParams.get('tenant') || '';
  }
}

// 2. DATOS PARA LA LANDING (Solo si no es subdominio)
let shopCount = "10+";
let userCount = "50+";

if (!isSubdomain) {
  const db = Astro.locals.runtime?.env?.DB;
  if (db) {
    try {
      const shops = await db.prepare("SELECT COUNT(*) as total FROM tenants").first();
      const users = await db.prepare("SELECT COUNT(*) as total FROM users").first();
      if (shops?.total) shopCount = shops.total.toString();
      if (users?.total) userCount = users.total.toString();
    } catch(e) {
      console.error("Stats Error:", e);
    }
  }
}

const metadata = { title: 'TuStock - Plataforma Retail' };
---

{
  isSubdomain ? (
    // CASO A: TIENDA PÚBLICA (Storefront)
    // Aquí cargamos el escaparate para clientes
    <StoreFront tenant={tenantSlug} />
  ) : (
    // CASO B: LANDING PAGE CORPORATIVA
    <Layout metadata={metadata}>
      <MainHome shopCount={shopCount} userCount={userCount} />
    </Layout>
  )
}