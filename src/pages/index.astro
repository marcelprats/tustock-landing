---
// 1. IMPORTANTE: Importar el Layout que trae el CSS
import Layout from '~/layouts/PageLayout.astro';

import MainHome from '~/components/landing/MainHome.astro';
import AppDashboard from '~/components/app/AppDashboard.astro';

const url = new URL(Astro.request.url);
const hostname = url.hostname;
let isSubdomain = false;
let tenantSlug = '';

// --- L√ìGICA DE SUBDOMINIOS ---
if (import.meta.env.PROD) {
  if (hostname !== 'tustock.app' && hostname !== 'www.tustock.app') {
    isSubdomain = true;
    tenantSlug = hostname.split('.')[0];
  }
} else {
  if (url.searchParams.has('tenant')) {
    isSubdomain = true;
    tenantSlug = url.searchParams.get('tenant');
  }
}

const session = Astro.cookies.get('session');
const isLoggedIn = session && session.value;

if (isSubdomain && !isLoggedIn) {
  const loginUrl = import.meta.env.PROD 
    ? `https://tustock.app/login?return_to=${tenantSlug}` 
    : `/login?return_to=${tenantSlug}`;
  return Astro.redirect(loginUrl);
}

// Metadatos para la Landing
const metadata = {
  title: 'TuStock - Gesti√≥n de Inventario con IA',
  ignoreTitleTemplate: true,
};
---

{
  isSubdomain && isLoggedIn ? (
    /* CASO A: DASHBOARD (Tienda) */
    /* Nota: Aseg√∫rate de que AppDashboard tambi√©n tenga su propio Layout interno 
       o envu√©lvelo aqu√≠ si se ve sin estilos */
    <AppDashboard tenant={tenantSlug} />
  ) : (
    /* CASO B: LANDING PAGE */
    /* üî• AQU√ç ESTABA EL ERROR: Faltaba el <Layout> */
    <Layout metadata={metadata}>
      <MainHome />
    </Layout>
  )
}