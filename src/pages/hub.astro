---
import Layout from '~/layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';

// 1. SEGURIDAD: SI NO HAY COOKIE, AL LOGIN
const session = Astro.cookies.get('session');
if (!session || !session.value) {
  return Astro.redirect('/login');
}

// 2. OBTENER DATOS REALES (LÃ³gica de tu HubSelector)
const userId = session.value;
const db = Astro.locals.runtime?.env?.DB;

let userStores = [];
let userName = "Usuario";

if (userId && db) {
  try {
    // Nombre del usuario
    const userRes = await db.prepare("SELECT full_name FROM users WHERE id = ?").bind(userId).first();
    if (userRes) userName = userRes.full_name;

    // Tiendas
    const storesRes = await db.prepare(`
      SELECT t.name, t.slug, t.status, t.plan_type, m.role 
      FROM memberships m
      JOIN tenants t ON m.tenant_id = t.id
      WHERE m.user_id = ?
    `).bind(userId).all();
    
    if (storesRes.results) {
      userStores = storesRes.results.map(s => {
        const isPending = s.status === 'PENDING';
        return {
          ...s, 
          // Si es PROD: https://tienda.tustock.app | Si es DEV: /?tenant=tienda
          url: isPending 
               ? '#' 
               : (import.meta.env.PROD ? `https://${s.slug}.tustock.app` : `/?tenant=${s.slug}`),
          isPending
        };
      });
    }
  } catch (e) {
    console.error("Error cargando Hub:", e);
  }
}

const metadata = { title: 'Mis Tiendas - TuStock' };
---

<Layout metadata={metadata}>
  <section class="relative min-h-screen px-4 py-16 sm:px-6 lg:px-8 bg-gray-50 dark:bg-slate-900">
    
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">
                    Hola, {userName} ðŸ‘‹
                </h1>
                <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">
                    Gestiona tus negocios desde un Ãºnico lugar.
                </p>
            </div>
            
            <div class="flex gap-3">
                <form action="/api/logout" method="POST">
                    <button type="submit" class="flex items-center gap-2 px-4 py-3 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border border-transparent hover:border-red-200">
                        <Icon name="tabler:logout" class="w-5 h-5" />
                        Salir
                    </button>
                </form>
                <a href="/new-store" class="btn-primary flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-lg hover:translate-y-[-2px] transition-all">
                    <Icon name="tabler:plus" class="w-5 h-5" />
                    Nueva Tienda
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        
        {userStores.length > 0 ? userStores.map((store) => (
            <a 
                href={store.url} 
                target={store.isPending ? "_self" : "_blank"}
                class={`group relative bg-white dark:bg-slate-800 border rounded-2xl p-8 shadow-sm hover:shadow-xl transition-all duration-300 hover:border-blue-500/50 flex flex-col justify-between h-full min-h-[220px]
                    ${store.isPending ? 'border-yellow-200 opacity-90 cursor-not-allowed' : 'border-gray-200 dark:border-gray-800'}`}
            >
            
            {/* ETIQUETA DE ESTADO */}
            <div class="flex justify-between items-start mb-6">
                <div class={`w-12 h-12 rounded-xl flex items-center justify-center transition-colors
                    ${store.isPending ? 'bg-yellow-100 text-yellow-600' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 group-hover:bg-blue-600 group-hover:text-white'}`}>
                    <Icon name="tabler:building-store" class="w-6 h-6" />
                </div>
                
                <div class="flex gap-2">
                    <span class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide 
                        ${store.plan_type === 'PRO' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600'}`}>
                        {store.plan_type || 'FREE'}
                    </span>
                    {store.isPending && (
                        <span class="bg-yellow-400 text-yellow-900 px-2 py-1 rounded text-[10px] font-bold">
                            CREANDO...
                        </span>
                    )}
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1 group-hover:text-blue-600 transition-colors">
                    {store.name}
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <Icon name="tabler:world" class="w-4 h-4" />
                    {store.slug}.tustock.app
                </p>
            </div>

            {!store.isPending && (
                <div class="mt-6 pt-6 border-t border-gray-100 dark:border-slate-700 flex items-center text-sm font-medium text-blue-600 group-hover:underline">
                    Entrar al Dashboard <Icon name="tabler:arrow-right" class="w-4 h-4 ml-auto transition-transform group-hover:translate-x-1" />
                </div>
            )}
            </a>
        )) : (
            /* EMPTY STATE */
            <div class="col-span-full flex flex-col items-center justify-center p-12 bg-white dark:bg-slate-800 rounded-2xl border border-dashed border-gray-300 dark:border-slate-700 text-center">
                <div class="w-16 h-16 bg-gray-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4">
                    <Icon name="tabler:building-store-off" class="w-8 h-8 text-gray-400" />
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">No tienes tiendas todavÃ­a</h3>
                <p class="text-gray-500 mb-6">Empieza creando tu primer negocio en la plataforma.</p>
                <a href="/new-store" class="btn-primary px-6 py-2 rounded-lg">Crear Primera Tienda</a>
            </div>
        )}

        {userStores.length > 0 && (
            <a href="/new-store" class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-slate-800/50 transition-all group h-full min-h-[220px]">
                <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                    <Icon name="tabler:plus" class="w-6 h-6 text-gray-500 group-hover:text-blue-500" />
                </div>
                <span class="font-medium text-gray-500 group-hover:text-blue-600">Crear otra tienda</span>
            </a>
        )}

        </div>
    </div>
  </section>
</Layout>