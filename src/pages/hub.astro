---
import Layout from '~/layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';

// 1. SEGURIDAD: SI NO HAY COOKIE, AL LOGIN
const session = Astro.cookies.get('session');
if (!session || !session.value) {
  return Astro.redirect('/login');
}

// 2. OBTENER DATOS REALES
const userId = session.value;
const db = Astro.locals.runtime?.env?.DB;

let userStores = [];
let userName = "Usuario";

if (userId && db) {
  try {
    const userRes = await db.prepare("SELECT full_name FROM users WHERE id = ?").bind(userId).first();
    if (userRes) userName = userRes.full_name;

    const storesRes = await db.prepare(`
      SELECT t.name, t.slug, t.status, t.web_plan, m.role 
      FROM memberships m
      JOIN tenants t ON m.tenant_id = t.id
      WHERE m.user_id = ?
    `).bind(userId).all();
    
    if (storesRes.results) {
      userStores = storesRes.results.map(s => {
        const isPending = s.status === 'PENDING';
        return {
          ...s, 
          url: isPending 
               ? '#' 
               : (import.meta.env.PROD ? `https://${s.slug}.tustock.app` : `/?tenant=${s.slug}`),
          isPending
        };
      });
    }
  } catch (e) {
    console.error("Error cargando Hub:", e);
  }
}

const metadata = { title: 'Mis Tiendas - TuStock' };
---

<Layout metadata={metadata}>
  <section class="relative min-h-screen px-4 py-16 sm:px-6 lg:px-8 bg-slate-50 dark:bg-[#0b1120] overflow-hidden">
    
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-500/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-500/10 rounded-full blur-[120px]"></div>
    </div>

    <div class="max-w-7xl mx-auto relative z-10">
        <div class="flex flex-col md:flex-row justify-between items-center mb-16 gap-6 text-center md:text-left">
            <div>
                <h1 class="text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white sm:text-5xl">
                    Hola, <span class="text-blue-600 dark:text-blue-400">{userName.split(' ')[0]}</span> 游녦
                </h1>
                <p class="mt-3 text-lg text-slate-600 dark:text-slate-400 max-w-2xl">
                    Bienvenido de nuevo. Selecciona el ecosistema que deseas gestionar hoy.
                </p>
            </div>
            
            <div class="flex items-center gap-4">
                <form action="/api/logout" method="POST">
                    <button type="submit" class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold text-slate-600 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-800 hover:shadow-md transition-all border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                        <Icon name="tabler:logout" class="w-5 h-5" />
                        Cerrar Sesi칩n
                    </button>
                </form>
                <a href="/new-store" class="flex items-center gap-2 px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 hover:translate-y-[-2px] active:scale-95 transition-all">
                    <Icon name="tabler:plus" class="w-5 h-5" />
                    Nueva Unidad
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        
        {userStores.map((store) => (
            <a 
                href={store.url} 
                target={store.isPending ? "_self" : "_blank"}
                /* 游댠 ATRIBUTOS CR칈TICOS PARA EL SCRIPT 游댠 */
                data-status={store.status} 
                data-slug={store.slug} 
                data-id={store.id} 
                class={`group relative flex flex-col justify-between min-h-[260px] p-8 rounded-3xl transition-all duration-500
                    ${store.isPending 
                        ? 'bg-slate-100 dark:bg-slate-800/50 border-2 border-dashed border-slate-300 dark:border-slate-700 cursor-wait' 
                        : 'bg-white dark:bg-slate-900/50 backdrop-blur-sm border border-slate-200 dark:border-slate-800 hover:border-blue-500 dark:hover:border-blue-400 shadow-sm hover:shadow-2xl hover:-translate-y-2'
                    }`}
            >
                <div class="flex justify-between items-start">
                    <div class={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all duration-500
                        ${store.isPending 
                            ? 'bg-slate-200 dark:bg-slate-700 text-slate-400' 
                            : 'bg-slate-50 dark:bg-slate-800 text-blue-600 dark:text-blue-400 group-hover:bg-blue-600 group-hover:text-white group-hover:rotate-6'}`}>
                        {/* Si est치 pendiente, animamos el icono de carga */}
                        <Icon name={store.isPending ? "tabler:loader-quarter" : "tabler:building-store"} class={`w-7 h-7 ${store.isPending ? 'animate-spin' : ''}`} />
                    </div>

                    <div class="flex flex-col items-end gap-2">
                        <span class={`px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest border
                            ${store.web_plan === 'PRO' 
                                ? 'bg-amber-500/10 border-amber-500/20 text-amber-600 dark:text-amber-400' 
                                : 'bg-slate-100 border-slate-200 text-slate-500 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400'}`}>
                            {store.web_plan || 'FREE'}
                        </span>
                        {store.role === 'OWNER' && (
                            <span class="text-[9px] font-bold text-blue-500 uppercase tracking-tighter bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded">Propietario</span>
                        )}
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                        {store.name}
                    </h3>
                    <div class="mt-2 flex items-center gap-2 text-slate-500 dark:text-slate-400 font-medium">
                        <Icon name="tabler:world" class="w-4 h-4" />
                        <span class="text-sm">{store.slug}.tustock.app</span>
                    </div>
                </div>

                <div class="mt-8 flex items-center justify-between">
                    {store.isPending ? (
                        <div class="flex flex-col gap-2 w-full">
                            <span class="text-sm font-bold text-amber-600 flex items-center gap-2">
                                <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-amber-500"></span>
                                </span>
                                Configurando entorno...
                            </span>
                            {/* Barra de progreso visual sutil */}
                            <div class="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-500 animate-[loading_2s_ease-in-out_infinite]"></div>
                            </div>
                        </div>
                    ) : (
                        <>
                            <span class="text-xs font-semibold text-slate-400 group-hover:text-blue-500 transition-colors uppercase tracking-widest">Entrar</span>
                            <div class="w-8 h-8 rounded-full border border-slate-200 dark:border-slate-700 flex items-center justify-center group-hover:bg-blue-600 group-hover:border-blue-600 transition-all duration-300">
                                <Icon name="tabler:chevron-right" class="w-4 h-4 text-slate-400 group-hover:text-white" />
                            </div>
                        </>
                    )}
                </div>
            </a>
        ))}

        <a href="/new-store" class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-800 rounded-3xl hover:border-blue-500 dark:hover:border-blue-500 hover:bg-white dark:hover:bg-slate-900/50 transition-all group min-h-[260px]">
            <div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4 group-hover:scale-110 group-hover:bg-blue-600 transition-all duration-500">
                <Icon name="tabler:plus" class="w-8 h-8 text-slate-400 group-hover:text-white" />
            </div>
            <span class="text-lg font-bold text-slate-400 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">A침adir Negocio</span>
            <p class="text-sm text-slate-400 mt-1">Expande tu ecosistema</p>
        </a>

        </div>
    </div>
  </section>
</Layout>

<style>
    /* Efecto de entrada suave para las tarjetas */
    .grid > a {
        animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) both;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes loading {
    0% { width: 0%; transform: translateX(-100%); }
    50% { width: 100%; transform: translateX(0); }
    100% { width: 0%; transform: translateX(100%); }
    }

    /* Retraso escalonado para las tarjetas */
    .grid > a:nth-child(1) { animation-delay: 0.1s; }
    .grid > a:nth-child(2) { animation-delay: 0.2s; }
    .grid > a:nth-child(3) { animation-delay: 0.3s; }
</style>

<script is:inline>
  async function checkPendingStores() {
    // 1. Buscamos todas las tarjetas que est치n en estado "PENDING"
    const pendingCards = document.querySelectorAll('[data-status="PENDING"]');
    
    if (pendingCards.length === 0) return;

    for (const card of pendingCards) {
      const slug = card.getAttribute('data-slug');
      const storeId = card.getAttribute('data-id');

      try {
        // 2. Hacemos un "ping" a la tienda
        // En local usamos /?tenant=slug, en prod la URL real
        const checkUrl = window.location.hostname.includes('localhost') 
          ? `/?tenant=${slug}` 
          : `https://${slug}.tustock.app`;

        const res = await fetch(checkUrl, { method: 'HEAD', mode: 'no-cors' });

        // 3. Si responde (aunque sea opaque por no-cors), consideramos que est치 viva
        // Enviamos se침al a nuestra API para activar en D1
        await fetch('/api/activate-store', {
          method: 'POST',
          body: JSON.stringify({ storeId })
        });

        // 4. Recargamos la p치gina para que el usuario vea el bot칩n de ENTRAR
        window.location.reload();
        
      } catch (e) {
        console.log(`Tienda ${slug} a칰n no responde...`);
      }
    }
  }

  // Ejecutar cada 3 segundos si hay pendientes
  setInterval(checkPendingStores, 3000);
</script>