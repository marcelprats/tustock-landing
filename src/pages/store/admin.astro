---
import PageLayout from '~/layouts/PageLayout.astro';
import StoreHeader from '~/components/widgets/StoreHeader.astro';
import { Icon } from 'astro-icon/components';

// 1. OBTENER SESIÓN Y DATOS
const session = Astro.cookies.get('session');
const { currentShop } = Astro.locals;
const env = Astro.locals.runtime?.env;

// Si no hay sesión, al login
if (!session) return Astro.redirect(`/login?redirect=/admin`);

const userId = session.value;
let isAuthorized = false;
let userRole = "";
let errorMsg = "";

// 2. VERIFICACIÓN DE PERMISOS (SOLO D1)
try {
    const db = env?.DB; // Tu base de datos D1 local

    if (!db) throw new Error("No se encuentra la base de datos D1");

    // PASO A: Buscar el ID de la tienda actual
    const tenant = await db.prepare("SELECT id, name FROM tenants WHERE slug = ?").bind(currentShop.slug).first();

    if (!tenant) throw new Error(`Tienda no encontrada.`);

    // PASO B: Verificar membresía
    const membership = await db.prepare("SELECT role FROM memberships WHERE user_id = ? AND tenant_id = ?")
        .bind(userId, tenant.id)
        .first();

    if (membership) {
        isAuthorized = true;
        userRole = membership.role;
    } else {
        errorMsg = "No tienes permisos de administración en esta tienda.";
    }

} catch (e) {
    console.error("Error Admin Check D1:", e);
    // En desarrollo (mock) permitimos acceso si falla DB, pero en prod mostramos error
    if (import.meta.env.DEV) {
        isAuthorized = true;
        userRole = "DEV_OWNER";
    } else {
        errorMsg = `Error de autorización: ${e.message}`;
    }
}

const shopName = currentShop?.name || "Panel de Control";
const metadata = { title: `Admin - ${shopName}` };

// HEADER DATA (Para mantener consistencia visual)
const storeHeaderData = {
  links: [
    { text: 'Ver Tienda', href: '/' },
  ],
  actions: []
};
---

<PageLayout metadata={metadata}>

  {/* Header Específico */}
  <fragment slot="header">
    <StoreHeader
      {...storeHeaderData}
      shopName={`Admin: ${shopName}`}
      isSticky
      showToggleTheme
    />
  </fragment>

  <div class="min-h-screen bg-slate-50 dark:bg-slate-900 py-12 px-4 sm:px-6 lg:px-8">
    
    <div class="max-w-7xl mx-auto">
        
        {/* ENCABEZADO DASHBOARD */}
        <div class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                    <Icon name="tabler:layout-dashboard" class="w-8 h-8 text-blue-600" />
                    Dashboard
                </h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">
                    Bienvenido de nuevo. Aquí tienes el control total de <span class="font-semibold text-blue-500">{shopName}</span>.
                </p>
            </div>
            <div class="flex items-center gap-3">
                 <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-bold uppercase tracking-wide border border-blue-200">
                    {userRole}
                 </span>
                 <form action="/api/logout" method="POST">
                    <button type="submit" class="p-2 rounded-lg bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-700 hover:text-red-500 transition-colors" title="Cerrar Sesión">
                        <Icon name="tabler:logout" class="w-5 h-5" />
                    </button>
                </form>
            </div>
        </div>

        {errorMsg && !isAuthorized ? (
            <div class="p-6 bg-red-50 border border-red-200 rounded-xl text-center text-red-800 max-w-2xl mx-auto mt-20">
                <Icon name="tabler:alert-triangle" class="w-12 h-12 mx-auto mb-4 text-red-500" />
                <h3 class="text-lg font-bold">Acceso Restringido</h3>
                <p>{errorMsg}</p>
                <a href="/" class="mt-4 inline-block text-blue-600 underline">Volver al inicio</a>
            </div>
        ) : (

            /* GRID DE TARJETAS */
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                {/* 1. EDITAR TIENDA (SETTINGS) */}
                <a href="/admin/settings" class="group p-6 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all hover:-translate-y-1">
                    <div class="w-12 h-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <Icon name="tabler:settings" class="w-6 h-6" />
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Configuración Tienda</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Edita el nombre, logo y apariencia general.</p>
                </a>

                {/* 2. CATÁLOGO */}
                <div class="group p-6 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 cursor-pointer">
                    <div class="w-12 h-12 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center mb-4 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                        <Icon name="tabler:package" class="w-6 h-6" />
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Catálogo</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Gestiona tus productos, precios y stock.</p>
                </div>

                {/* 3. PEDIDOS */}
                <div class="group p-6 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 cursor-pointer">
                    <div class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center mb-4 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                        <Icon name="tabler:truck-delivery" class="w-6 h-6" />
                    </div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Pedidos</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Revisa y procesa nuevas ventas.</p>
                        </div>
                        <span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">0 Nuevos</span>
                    </div>
                </div>

                {/* 4. CLIENTES */}
                <div class="group p-6 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 cursor-pointer">
                    <div class="w-12 h-12 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-600 flex items-center justify-center mb-4 group-hover:bg-amber-600 group-hover:text-white transition-colors">
                        <Icon name="tabler:users" class="w-6 h-6" />
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Clientes</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Base de datos de compradores.</p>
                </div>

                {/* 5. INTEGRACIONES */}
                <div class="group p-6 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm opacity-60">
                    <div class="w-12 h-12 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-500 flex items-center justify-center mb-4">
                        <Icon name="tabler:puzzle" class="w-6 h-6" />
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Integraciones</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Próximamente: Conecta con Instagram y WhatsApp API.</p>
                </div>

                {/* 6. VOLVER AL HUB */}
                <a href="https://tustock.app/hub" class="group p-6 bg-slate-100 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 flex flex-col items-center justify-center text-center hover:bg-white dark:hover:bg-slate-800 transition-all">
                    <Icon name="tabler:arrow-back-up" class="w-8 h-8 text-gray-400 mb-2 group-hover:text-gray-600 dark:group-hover:text-gray-300" />
                    <h3 class="text-base font-bold text-gray-500 dark:text-gray-400 group-hover:text-gray-800 dark:group-hover:text-white">Volver a mis tiendas</h3>
                </a>

            </div>
        )}
    </div>
  </div>

</PageLayout>
