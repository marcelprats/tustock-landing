---
import Layout from '~/layouts/Layout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import StoreDashboard from '~/components/store/admin/StoreDashboard.astro'; 
import { createClient } from "@libsql/client/web";

const { currentShop } = Astro.locals;
const session = Astro.cookies.get('session');

// 1. SI NO HAY SESIÓN -> AL LOGIN
if (!session) {
  // Guardamos a dónde quería ir para volver después
  return Astro.redirect(`/login?redirect=/admin`);
}

// 2. SEGURIDAD: ¿ES EL DUEÑO O TIENE PERMISO?
const userId = session.value;
const env = Astro.locals.runtime?.env; 
let isAuthorized = false;

if (env?.TURSO_DB_URL && env?.TURSO_AUTH_TOKEN && currentShop) {
  try {
    const turso = createClient({ url: env.TURSO_DB_URL, authToken: env.TURSO_AUTH_TOKEN });

    // CONSULTA DE SEGURIDAD
    // Buscamos si el usuario actual es el propietario de esta licencia específica.
    // Ajusta esta query si tienes un sistema de roles más complejo (tabla memberships).
    const result = await turso.execute({
        sql: `
            SELECT id FROM licenses 
            WHERE website_url LIKE ? 
            AND owner_email = (SELECT email FROM users WHERE id = ?)
            LIMIT 1
        `,
        args: [`%${currentShop.slug}%`, userId]
    });

    if (result.rows.length > 0) {
        isAuthorized = true;
    }

  } catch (e) {
    console.error("Error comprobando permisos en Admin:", e);
  }
}

// 3. SI NO ESTÁ AUTORIZADO -> EXPULSAR
if (!isAuthorized) {
    // Si está logueado pero no es su tienda, lo mandamos al Hub central
    return Astro.redirect('https://tustock.app/hub');
}

const metadata = { title: `Admin - ${currentShop?.name}` };
---

<Layout tenant={currentShop.slug} metadata={metadata}>
  
  <HeroText
    tagline="Panel de Control"
    title={currentShop.name}
    subtitle="Gestión segura de tu negocio."
  />

  <StoreDashboard tenantId={currentShop.slug} />

</Layout>