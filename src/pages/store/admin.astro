---
import Layout from '~/layouts/Layout.astro';
import { createClient } from "@libsql/client/web";
import { Icon } from 'astro-icon/components';

// 1. OBTENER SESIN Y TIENDA ACTUAL
const session = Astro.cookies.get('session');
const { currentShop } = Astro.locals;

//  MEJORA: Intentamos pillar las variables de entorno de todas las formas posibles
const env = Astro.locals.runtime?.env || import.meta.env;

// Si no hay sesi贸n, al login
if (!session) {
  return Astro.redirect(`/login?redirect=/admin`);
}

const userId = session.value;
let isAuthorized = false;
let errorMsg = "";
let debugInfo = ""; // Para ver detalles t茅cnicos si falla

// 2. SEGURIDAD: 驴ES EL DUEO?
if (env?.TURSO_DB_URL && env?.TURSO_AUTH_TOKEN && currentShop) {
  try {
    const turso = createClient({ url: env.TURSO_DB_URL, authToken: env.TURSO_AUTH_TOKEN });

    // Consulta de verificaci贸n
    const result = await turso.execute({
        sql: `
            SELECT id FROM licenses 
            WHERE website_url LIKE ? 
            AND owner_email = (SELECT email FROM users WHERE id = ?)
            LIMIT 1
        `,
        args: [`%${currentShop.slug}%`, userId]
    });

    if (result.rows.length > 0) {
        isAuthorized = true;
    } else {
        // Si no devuelve filas, es que el email del usuario NO coincide con el owner_email de la licencia
        errorMsg = "No eres el propietario de esta licencia.";
        debugInfo = `Usuario ID: ${userId} vs Tienda: ${currentShop.slug}`;
    }

  } catch (e) {
    console.error("Error Admin Check:", e);
    //  AQU EST EL CAMBIO: Mostramos el error real
    errorMsg = `Error T茅cnico: ${e.message}`;
  }
} else {
    errorMsg = "Error de Configuraci贸n: Faltan variables de entorno (DB_URL o TOKEN)";
}

// Si no est谩 autorizado y no hay error t茅cnico, expulsamos (Opcional, ahora lo dejo para ver el error)
// if (!isAuthorized && !errorMsg) return Astro.redirect('https://tustock.app/hub');

const metadata = { title: `Admin - ${currentShop?.name}` };
---

<Layout metadata={metadata}>
  
  <div class="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col items-center py-20 px-4">
    
    <div class="w-full max-w-4xl text-center mb-12">
        <div class="inline-flex items-center justify-center p-3 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 mb-4 shadow-lg">
            <Icon name="tabler:dashboard" class="w-10 h-10" />
        </div>
        <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-gray-900 dark:text-white mb-2">
            Panel de Control
        </h1>
        <p class="text-xl text-gray-500 dark:text-gray-400">
            Gestionando: <span class="font-bold text-blue-600">{currentShop?.name}</span>
        </p>
    </div>

    {/* ZONA DE ERRORES / DEBUG */}
    {errorMsg ? (
        <div class="p-8 bg-red-50 border border-red-200 text-red-800 rounded-xl max-w-2xl text-center shadow-lg">
            <Icon name="tabler:bug" class="w-12 h-12 mx-auto mb-4 text-red-500" />
            <h3 class="text-xl font-bold mb-2">Acceso Denegado</h3>
            
            <p class="text-lg font-medium">{errorMsg}</p>
            
            {debugInfo && (
                <p class="mt-2 text-sm font-mono bg-red-100 p-2 rounded">{debugInfo}</p>
            )}

            <div class="mt-6 flex justify-center gap-4">
                <a href="https://tustock.app/hub" class="px-6 py-2 bg-white border border-red-300 rounded-lg hover:bg-red-100 transition-colors">
                    Volver al Hub
                </a>
                <form action="/api/logout" method="POST">
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Cerrar Sesi贸n
                    </button>
                </form>
            </div>
        </div>
    ) : (
        /* DASHBOARD REAL (Solo se ve si no hay error) */
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl animate-fade-in-up">
            
            <a href="https://tustock.app/hub" class="group relative p-8 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-xl transition-all duration-300 flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-2xl bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 mb-4 group-hover:scale-110 transition-transform">
                    <Icon name="tabler:building-store" class="w-8 h-8" />
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Mis Tiendas</h3>
                <p class="text-gray-500 text-sm">Volver al selector de empresas.</p>
            </a>

            <div class="p-8 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm opacity-60 flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 mb-4">
                    <Icon name="tabler:settings" class="w-8 h-8" />
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Configuraci贸n</h3>
                <p class="text-gray-500 text-sm">Pr贸ximamente.</p>
            </div>

            <div class="col-span-1 md:col-span-2 mt-8 flex justify-center">
                <form action="/api/logout" method="POST">
                    <button type="submit" class="flex items-center gap-2 px-8 py-3 rounded-full bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white transition-all duration-300 font-semibold">
                        <Icon name="tabler:logout" class="w-5 h-5" />
                        Salir de {currentShop?.name}
                    </button>
                </form>
            </div>

        </div>
    )}

  </div>
</Layout>