---
import Layout from '~/layouts/PageLayout.astro';

// --- GUEST GUARD: Si ya tienes sesión, al Hub ---
const session = Astro.cookies.get('session');
if (session && session.value) {
  return Astro.redirect('/hub');
}

// Lógica de retorno (por si vienes de un subdominio)
const returnTo = Astro.url.searchParams.get('return_to');
const title = returnTo ? `Entrar a ${returnTo}` : "Bienvenido a TuStock";

const metadata = {
  title: "Iniciar Sesión",
};
---

<Layout metadata={metadata}>
  <section class="relative h-screen flex flex-col items-center justify-center bg-gray-900 overflow-hidden">
    
    {/* Fondo decorativo opcional */}
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-gray-900 to-gray-900"></div>

    <div class="relative w-full max-w-md p-8 bg-gray-800/50 backdrop-blur-xl border border-gray-700 rounded-2xl shadow-2xl">
      
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">{title}</h1>
        <p class="text-gray-400 text-sm">Introduce tus credenciales de acceso</p>
      </div>

      <form id="login-form" class="space-y-6">
        
        {/* INPUT EMAIL */}
        <div>
          <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Correo Electrónico</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required 
            placeholder="ejemplo@empresa.com"
            class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
          />
        </div>

        {/* INPUT PASSWORD */}
        <div>
          <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Contraseña</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            required 
            placeholder="••••••••"
            class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
          />
        </div>

        {/* MENSAJE DE ERROR (Oculto por defecto) */}
        <div id="error-message" class="hidden p-3 bg-red-500/10 border border-red-500/50 rounded-lg text-red-400 text-sm text-center">
        </div>

        {/* BOTÓN SUBMIT */}
        <button 
          type="submit" 
          id="submit-btn"
          class="w-full py-3.5 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg hover:shadow-blue-600/30 transition-all transform active:scale-95 flex justify-center items-center gap-2"
        >
          <span>Entrar</span>
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
        </button>

      </form>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-500">¿No tienes cuenta? <a href="/register" class="text-blue-400 hover:text-blue-300 font-medium">Regístrate gratis</a></p>
      </div>

    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('login-form');
  const errorMsg = document.getElementById('error-message');
  const btn = document.getElementById('submit-btn');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Resetear estado visual
      errorMsg.classList.add('hidden');
      errorMsg.innerText = '';
      btn.innerHTML = '<span class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span> Cargando...';
      btn.setAttribute('disabled', 'true');
      btn.classList.add('opacity-75', 'cursor-not-allowed');

      // Obtener datos
      const formData = new FormData(e.target);
      const email = formData.get('email');
      const password = formData.get('password');

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const data = await res.json();

        if (res.ok && data.success) {
          // ÉXITO: Redirigir a donde diga la API (generalmente /hub o el subdominio)
          window.location.href = data.redirectUrl;
        } else {
          throw new Error(data.error || 'Error al iniciar sesión');
        }

      } catch (err) {
        // Mostrar error visualmente
        errorMsg.classList.remove('hidden');
        errorMsg.innerText = err.message;
        
        // Restaurar botón
        btn.innerHTML = '<span>Entrar</span><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>';
        btn.removeAttribute('disabled');
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    });
  }
</script>
