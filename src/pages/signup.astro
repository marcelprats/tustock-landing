---
// src/pages/signup.astro
// Si tu Layout se llama diferente (ej: Layout.astro), cambia esta línea:
import Layout from '~/layouts/PageLayout.astro';
---

<Layout title="Regístrate en TuStock">
  <main class="flex items-center justify-center min-h-screen bg-gray-50">
    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
      
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900">Crear Cuenta</h1>
        <p class="mt-2 text-sm text-gray-600">Empieza a gestionar tu stock hoy mismo</p>
      </div>

      <form id="registro-form" class="space-y-4">
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre de tu Negocio</label>
          <input type="text" name="name" required placeholder="Frutería Paco" 
            class="w-full px-3 py-2 mt-1 border rounded-md focus:ring-blue-500 focus:border-blue-500 border-gray-300" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" name="email" required placeholder="paco@fruteria.com" 
            class="w-full px-3 py-2 mt-1 border rounded-md focus:ring-blue-500 focus:border-blue-500 border-gray-300" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Tu dirección web única</label>
          <div class="flex mt-1 rounded-md shadow-sm">
            <input type="text" name="subdomain" id="subdomain" required placeholder="fruteria-paco" pattern="[a-z0-9-]+"
              class="flex-1 w-full px-3 py-2 border border-r-0 rounded-l-md focus:ring-blue-500 focus:border-blue-500 border-gray-300" />
            <span class="inline-flex items-center px-3 text-gray-500 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md">
              .tustock.app
            </span>
          </div>
          <p class="mt-1 text-xs text-gray-500">Solo letras minúsculas, números y guiones.</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Contraseña</label>
          <input type="password" name="password" required placeholder="********" 
            class="w-full px-3 py-2 mt-1 border rounded-md focus:ring-blue-500 focus:border-blue-500 border-gray-300" />
        </div>

        <button type="submit" id="btn-submit"
          class="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          Crear Cuenta
        </button>

        <p id="mensaje" class="text-sm text-center text-red-600 hidden"></p>

      </form>
    </div>
  </main>
</Layout>

<script>
  // ESTE SCRIPT ES EL QUE HABLA CON TU API
  const form = document.getElementById('registro-form');
  const msg = document.getElementById('mensaje');
  const btn = document.getElementById('btn-submit');
  const subInput = document.getElementById('subdomain');

  // 1. Truquito: Forzar minúsculas en el subdominio mientras escribe
  subInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
  });

  // 2. Cuando le da a Enviar
  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // Que no recargue la página
    
    // Bloquear botón para que no pulse 2 veces
    btn.disabled = true;
    btn.innerText = "Creando cuenta...";
    msg.classList.add('hidden');

    // Coger los datos del formulario
    const formData = new FormData(form);
    const datos = Object.fromEntries(formData);

    try {
      // LLAMADA A TU API (functions/api/register.js)
      const response = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });

      const result = await response.json();

      if (response.ok) {
        // ¡ÉXITO!
        msg.classList.remove('hidden');
        msg.classList.replace('text-red-600', 'text-green-600');
        msg.innerText = "¡Cuenta creada! Redirigiendo...";
        
        // Redirigir a su nuevo dominio (o al login)
        setTimeout(() => {
            // De momento te mando al home, luego lo cambiaremos
            window.location.href = "/"; 
        }, 2000);

      } else {
        // ERROR (ej: "Dominio ocupado")
        throw new Error(result.error || "Error desconocido");
      }

    } catch (error) {
      msg.classList.remove('hidden');
      msg.innerText = error.message;
      btn.disabled = false;
      btn.innerText = "Crear Cuenta";
    }
  });
</script>
